#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <math.h>

#define MAX_CUSTOMERS 5000     // Maximum customers that can be handled in a day
#define SIM_TIME 480           // Total simulation time = 480 minutes (8 hours)
#define MAX_TELLERS 5          // Maximum tellers available

// ---------------------------------------------
// Function: poisson
// Purpose : Generate random number of arrivals per minute
//           using Poisson distribution with parameter λ (lambda)
// ---------------------------------------------
int poisson(double lambda) {
    if (lambda <= 0.0) return 0;
    double L = exp(-lambda);    // base for Poisson formula
    int k = 0;
    double p = 1.0;
    while (p > L) {             // continue until probability drops below threshold
        k++;
        double u = rand() / (RAND_MAX + 1.0); // random number between 0 and 1
        p *= u;
    }
    return k - 1;               // return the number of arrivals
}

int main() {
    int queue[MAX_CUSTOMERS];    // queue array to store arrival times
    int front = 0, rear = 0;     // queue front and rear pointers
    int teller_busy[MAX_TELLERS] = {0}; // keeps track of how long each teller is busy
    int wait_times[MAX_CUSTOMERS];       // stores wait time of each served customer
    int total_wait = 0, max_wait = 0, served = 0;

    double lambda;               // average number of customers per minute
    int num_tellers;             // number of tellers in the bank

    // -------------------------------
    // User Input Section
    // -------------------------------
    printf("Enter average customers per minute (lambda, e.g. 0.6): ");
    if (scanf("%lf", &lambda) != 1) return 1;
    printf("Enter number of tellers (1-%d): ", MAX_TELLERS);
    if (scanf("%d", &num_tellers) != 1) return 1;

    if (num_tellers < 1) num_tellers = 1;
    if (num_tellers > MAX_TELLERS) num_tellers = MAX_TELLERS;

    srand((unsigned)time(NULL)); // seed random number generator

    // ---------------------------------------
    // 1. SIMULATION LOOP (Minute-by-Minute)
    // ---------------------------------------
    for (int minute = 0; minute < SIM_TIME; ++minute) {

        // --- (A) Customer Arrivals ---
        // Determine how many customers arrive this minute
        int arrivals = poisson(lambda);

        // Add new arrivals to the queue
        for (int a = 0; a < arrivals; ++a) {
            if (rear >= MAX_CUSTOMERS) {
                fprintf(stderr, "Queue overflow! Too many customers.\n");
                break;
            }
            queue[rear++] = minute;  // store their arrival time
        }

        // --- (B) Teller Service Logic ---
        for (int t = 0; t < num_tellers; ++t) {

            if (teller_busy[t] > 0) {
                teller_busy[t]--; // teller is busy serving
            }

            // If teller is free and there are customers waiting
            if (teller_busy[t] == 0 && front < rear) {
                int arrival_time = queue[front++]; // remove first from queue
                int wait = minute - arrival_time;  // calculate waiting time

                // store and update statistics
                wait_times[served++] = wait;
                total_wait += wait;
                if (wait > max_wait) max_wait = wait;

                // assign a random service time between 2–3 minutes
                teller_busy[t] = 2 + (rand() % 2);
                teller_busy[t]--;  // count current minute as already worked
                if (teller_busy[t] < 0) teller_busy[t] = 0;
            }
        }
    }

    // ---------------------------------------
    // 2. DRAIN REMAINING QUEUE (After 8 hours)
    // Continue serving until everyone is done
    // ---------------------------------------
    int minute = SIM_TIME;
    while (front < rear) {
        for (int t = 0; t < num_tellers; ++t) {

            if (teller_busy[t] > 0) {
                teller_busy[t]--;
            }

            if (teller_busy[t] == 0 && front < rear) {
                int arrival_time = queue[front++];
                int wait = minute - arrival_time;

                wait_times[served++] = wait;
                total_wait += wait;
                if (wait > max_wait) max_wait = wait;

                teller_busy[t] = 2 + (rand() % 2);
                teller_busy[t]--;
                if (teller_busy[t] < 0) teller_busy[t] = 0;
            }
        }

        minute++;
        // safety check to prevent infinite loop
        if (minute > SIM_TIME + MAX_CUSTOMERS * 10) break;
    }

    // ---------------------------------------
    // 3. OUTPUT REPORT
    // ---------------------------------------
    if (served == 0) {
        printf("No customers were served.\n");
    } else {
        double avg_wait = (double)total_wait / served;

        printf("\n===== Bank Queue Simulation Report =====\n");
        printf("Total simulated time: %d minutes (8 hours)\n", SIM_TIME);
        printf("Tellers working: %d\n", num_tellers);
        printf("Customers served: %d\n", served);
        printf("Average wait time: %.2f minutes\n", avg_wait);
        printf("Maximum wait time: %d minutes\n", max_wait);
        printf("========================================\n");
    }

    return 0;
}
